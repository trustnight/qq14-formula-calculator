name: è‡ªåŠ¨å‘å¸ƒæ„å»º

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€vå¼€å¤´çš„tagæ—¶è§¦å‘

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºtagç®¡ç†
        
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
      run: |
        Write-Host "=== ç‰ˆæœ¬ä¿¡æ¯ ==="
        Write-Host "Pythonç‰ˆæœ¬: $(python --version)"
        Write-Host "Pipç‰ˆæœ¬: $(pip --version)"
        Write-Host "Gitç‰ˆæœ¬: $(git --version)"
        Write-Host "æ“ä½œç³»ç»Ÿ: $env:OS"
        Write-Host "=================="
      shell: pwsh
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
        # æ£€æŸ¥PyInstallerç‰ˆæœ¬
        Write-Host "PyInstallerç‰ˆæœ¬: $(pyinstaller --version)"
        
    - name: ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
      run: |
        Write-Host "=== ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥ ==="
        
        # æ£€æŸ¥Pythonç‰ˆæœ¬
        $pythonVersion = python --version 2>&1
        if ($pythonVersion -match "Python (\d+\.\d+)") {
          $majorMinor = $matches[1]
          Write-Host "Pythonç‰ˆæœ¬: $majorMinor"
          
          if ([version]$majorMinor -ge [version]"3.8") {
            Write-Host "âœ… Pythonç‰ˆæœ¬å…¼å®¹"
          } else {
            Write-Host "âŒ Pythonç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦3.8+"
            exit 1
          }
        }
        
        # æ£€æŸ¥PyInstaller
        try {
          $pyinstallerVersion = pyinstaller --version 2>&1
          Write-Host "PyInstallerç‰ˆæœ¬: $pyinstallerVersion"
          Write-Host "âœ… PyInstallerå¯ç”¨"
        } catch {
          Write-Host "âŒ PyInstallerä¸å¯ç”¨"
          exit 1
        }
        
        # æ£€æŸ¥specæ–‡ä»¶
        if (Test-Path "main.spec") {
          Write-Host "âœ… main.specæ–‡ä»¶å­˜åœ¨"
        } else {
          Write-Host "âŒ main.specæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        }
        
        Write-Host "========================"
      shell: pwsh
        
    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        # æ¸…ç†ä¹‹å‰çš„æ„å»º
        if (Test-Path "dist") { Remove-Item "dist" -Recurse -Force }
        if (Test-Path "build") { Remove-Item "build" -Recurse -Force }
        
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p build
        
        # ä½¿ç”¨ç°æœ‰çš„specæ–‡ä»¶æ„å»ºï¼ˆä¸æŒ‡å®šé¢å¤–å‚æ•°ï¼‰
        Write-Host "å¼€å§‹æ„å»º..."
        pyinstaller main.spec
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        Write-Host "æ£€æŸ¥æ„å»ºç»“æœ..."
        if (Test-Path "dist/qq14-formula-calculator.exe") {
          Write-Host "âœ… æ„å»ºæˆåŠŸï¼æ–‡ä»¶åœ¨distç›®å½•"
          Copy-Item "dist/qq14-formula-calculator.exe" "build/qq14-formula-calculator.exe" -Force
        } else {
          Write-Host "âŒ æ„å»ºå¤±è´¥ï¼Œæ£€æŸ¥ç›®å½•å†…å®¹:"
          Write-Host "=== distç›®å½• ==="
          if (Test-Path "dist") { Get-ChildItem "dist" -Recurse }
          Write-Host "=== buildç›®å½• ==="
          if (Test-Path "build") { Get-ChildItem "build" -Recurse }
          Write-Host "=== å½“å‰ç›®å½• ==="
          Get-ChildItem "." -Filter "*.exe"
          exit 1
        }
        
        # åˆ›å»ºä¸­æ–‡ç‰ˆæœ¬
        Copy-Item "build/qq14-formula-calculator.exe" "build/FFXIVé…æ–¹è®¡ç®—å™¨.exe" -Force
        
        Write-Host "âœ… æ„å»ºå®Œæˆï¼"
        Write-Host "æ–‡ä»¶å¤§å°: $((Get-Item 'build/FFXIVé…æ–¹è®¡ç®—å™¨.exe').Length / 1MB) MB"
        Write-Host "è‹±æ–‡ç‰ˆ: build/qq14-formula-calculator.exe"
        Write-Host "ä¸­æ–‡ç‰ˆ: build/FFXIVé…æ–¹è®¡ç®—å™¨.exe"
        
        # éªŒè¯æ–‡ä»¶å­˜åœ¨
        Write-Host "=== éªŒè¯æ–‡ä»¶å­˜åœ¨ ==="
        if (Test-Path "build/FFXIVé…æ–¹è®¡ç®—å™¨.exe") { Write-Host "âœ… ä¸­æ–‡ç‰ˆæ–‡ä»¶å­˜åœ¨" } else { Write-Host "âŒ ä¸­æ–‡ç‰ˆæ–‡ä»¶ä¸å­˜åœ¨" }
        if (Test-Path "build/qq14-formula-calculator.exe") { Write-Host "âœ… è‹±æ–‡ç‰ˆæ–‡ä»¶å­˜åœ¨" } else { Write-Host "âŒ è‹±æ–‡ç‰ˆæ–‡ä»¶ä¸å­˜åœ¨" }
        if (Test-Path "README.md") { Write-Host "âœ… README.mdå­˜åœ¨" } else { Write-Host "âŒ README.mdä¸å­˜åœ¨" }
        if (Test-Path "requirements.txt") { Write-Host "âœ… requirements.txtå­˜åœ¨" } else { Write-Host "âŒ requirements.txtä¸å­˜åœ¨" }
        
        Write-Host "=== buildç›®å½•å†…å®¹ ==="
        Get-ChildItem "build" -Recurse
      shell: pwsh
        
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/FFXIVé…æ–¹è®¡ç®—å™¨.exe
          build/qq14-formula-calculator.exe
          README.md
          requirements.txt
        body: |
          ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ - ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½
          - **Windows (ä¸­æ–‡å)**: [FFXIVé…æ–¹è®¡ç®—å™¨.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/FFXIVé…æ–¹è®¡ç®—å™¨.exe)
          - **Windows (è‹±æ–‡å)**: [qq14-formula-calculator.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/qq14-formula-calculator.exe)
          
          ### ğŸ”§ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ä»»æ„ä¸€ä¸ª `.exe` æ–‡ä»¶
          2. åŒå‡»è¿è¡Œå³å¯ä½¿ç”¨
          3. æ— éœ€å®‰è£…Pythonç¯å¢ƒ
          4. åŒ…å«å®Œæ•´çš„å›¾æ ‡å’Œæ•°æ®åº“æ–‡ä»¶
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - è‡³å°‘ 4GB RAM
          - 100MB å¯ç”¨å­˜å‚¨ç©ºé—´
          
          ### ğŸ› ï¸ æ„å»ºè¯´æ˜
          - ä½¿ç”¨ `main.spec` é…ç½®æ–‡ä»¶æ„å»º
          - åŒ…å«æ‰€æœ‰å¿…è¦çš„ä¾èµ–å’Œæ•°æ®æ–‡ä»¶
          - å•æ–‡ä»¶éƒ¨ç½²ï¼Œä¾¿æºæ€§å¼º
          
          ### ğŸ†• æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹æäº¤è®°å½•äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ï¼š
          https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 HEAD^)...${{ github.ref_name }}
          
          ### ğŸ“Š æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - æ„å»ºç¯å¢ƒ: Windows Latest
          - Pythonç‰ˆæœ¬: 3.11
          - PyInstallerç‰ˆæœ¬: æœ€æ–°
          - æ„å»ºé…ç½®: main.spec
          - GitHub Actions: v4
          
          ---
          
          *æ­¤ç‰ˆæœ¬ç”±GitHub Actionsè‡ªåŠ¨æ„å»ºå‘å¸ƒ*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ç®¡ç†æ ‡ç­¾ï¼ˆä¿æŒæœ€å¤š2ä¸ªï¼‰
      run: |
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # è·å–æ‰€æœ‰æ ‡ç­¾å¹¶æŒ‰ç‰ˆæœ¬æ’åº
        $allTags = git tag --sort=-version:refname | Where-Object { $_ -match '^v\d+\.\d+\.\d+$' }
        
        Write-Host "å½“å‰æ‰€æœ‰æ ‡ç­¾: $($allTags -join ', ')"
        
        # å¦‚æœæ ‡ç­¾æ•°é‡è¶…è¿‡2ä¸ªï¼Œåˆ é™¤æœ€æ—§çš„
        if ($allTags.Count -gt 2) {
          $tagsToDelete = $allTags | Select-Object -Skip 2
          Write-Host "éœ€è¦åˆ é™¤çš„æ—§æ ‡ç­¾: $($tagsToDelete -join ', ')"
          
          foreach ($tag in $tagsToDelete) {
            Write-Host "æ­£åœ¨åˆ é™¤æ ‡ç­¾: $tag"
            
            # åˆ é™¤è¿œç¨‹æ ‡ç­¾
            try {
              git push origin --delete $tag
              Write-Host "è¿œç¨‹æ ‡ç­¾ $tag åˆ é™¤æˆåŠŸ"
            } catch {
              Write-Host "è¿œç¨‹æ ‡ç­¾ $tag åˆ é™¤å¤±è´¥ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰"
            }
            
            # åˆ é™¤æœ¬åœ°æ ‡ç­¾
            try {
              git tag -d $tag
              Write-Host "æœ¬åœ°æ ‡ç­¾ $tag åˆ é™¤æˆåŠŸ"
            } catch {
              Write-Host "æœ¬åœ°æ ‡ç­¾ $tag åˆ é™¤å¤±è´¥"
            }
          }
          
          # æ¨é€æ ‡ç­¾æ›´æ–°
          git push origin --tags
          Write-Host "æ ‡ç­¾ç®¡ç†å®Œæˆ"
        } else {
          Write-Host "æ ‡ç­¾æ•°é‡ä¸è¶…è¿‡2ä¸ªï¼Œæ— éœ€æ¸…ç†"
        }
      shell: pwsh
      
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: FFXIVé…æ–¹è®¡ç®—å™¨-${{ github.ref_name }}
        path: |
          build/FFXIVé…æ–¹è®¡ç®—å™¨.exe
          build/qq14-formula-calculator.exe
          dist/qq14-formula-calculator.exe
          README.md
          requirements.txt
        retention-days: 30 